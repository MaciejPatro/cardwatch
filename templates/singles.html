{% extends "base.html" %}
{% block content %}
<section class="add-form mb-3">
    <form method="post" action="{{ url_for('add_single') }}" enctype="multipart/form-data" class="card shadow-sm">
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-3">
                    <input name="name" class="form-control" placeholder="Card name" required>
                </div>
                <div class="col-12 col-md-4">
                    <input name="url" class="form-control" placeholder="Cardmarket URL" required>
                </div>
                <div class="col-6 col-md-2">
                    <select name="language" class="form-select" required>
                        <option value="English">English</option>
                        <option value="Japanese">Japanese</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <input type="file" name="image" class="form-control" aria-label="Image upload (optional)">
                </div>
                <div class="col-4 col-md-1 ms-auto text-end">
                    <button type="submit" class="btn btn-primary w-100">Add</button>
                </div>
            </div>
        </div>
    </form>
</section>

<div id="toolbar" class="d-flex gap-2 align-items-center flex-wrap">
    <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="applyPreset('liked')">Liked</button>
        <button type="button" class="btn btn-outline-secondary" onclick="applyPreset('boosters')">Boosters</button>
        <button type="button" class="btn btn-outline-success" onclick="applyPreset('medium')">Medium (â‚¬50-150)</button>
        <button type="button" class="btn btn-outline-dark" onclick="applyPreset('reset')">Reset</button>
    </div>
    <div class="input-group input-group-sm" style="width: 200px;">
        <span class="input-group-text">Price â‚¬</span>
        <input type="number" class="form-control" id="minPriceInput" placeholder="Min">
        <input type="number" class="form-control" id="maxPriceInput" placeholder="Max">
    </div>
    <select class="form-select form-select-sm" id="languageFilter" style="width: 120px;">
        <option value="">All Languages</option>
        <option value="English">English</option>
        <option value="Japanese">Japanese</option>
        <option value="Chinese">Chinese</option>
    </select>
    <select class="form-select form-select-sm" id="gameFilter" style="width: 120px;">
        <option value="">All Games</option>
        <option value="One Piece">One Piece</option>
        <option value="Riftbound">Riftbound</option>
    </select>
    <select class="form-select form-select-sm" id="categoryFilter" style="width: 150px;">
        <option value="">All Categories</option>
        <option value="None">Uncategorized</option>
        <option value="Booster Box">Booster Box</option>
        <option value="Pack">Pack</option>
        <option value="Don">Don</option>
        <option value="Liked">Liked</option>
        <option value="Ignore">Ignore</option>
    </select>
</div>

<table id="singleTable" class="table table-striped align-middle" data-toggle="table"
    data-url="{{ url_for('api_singles_list') }}" data-side-pagination="server" data-pagination="true"
    data-page-list="[10, 25, 50, 100, 200]" data-page-size="100" data-search="true" data-row-attributes="rowAttributes"
    data-row-style="rowStyle" data-toolbar="#toolbar" data-query-params="queryParams">
    <thead class="table-light">
        <tr>
            <th data-field="image_url" data-formatter="imageFormatter" data-width="120">Image</th>
            <th data-field="history_30d" data-formatter="sparklineFormatter" data-width="120">Graph (30d)</th>
            <th data-field="name" data-sortable="true" data-formatter="nameFormatter">Name</th>
            <th data-field="category" data-formatter="categoryFormatter">Category</th>
            <th data-field="language" data-sortable="true" data-formatter="languageFormatter" data-width="50"
                class="text-center"></th>
            <th data-field="current_low" data-sortable="true" da ta-sort-name="current" data-formatter="priceFormatter">
                Current â‚¬</th>
            <th data-field="from_price" data-formatter="priceFormatter">From â‚¬</th>
            <th data-field="supply" data-sortable="true">Items</th>
            <th data-field="price_trend" data-formatter="priceFormatter">Trend</th>
            <th data-field="avg7_price" data-formatter="priceFormatter">7-day</th>
            <th data-field="avg1_price" data-formatter="priceFormatter">1-day</th>
            <th data-field="pct_all" data-sortable="true" data-formatter="pctFormatter">All-time %</th>
            <th data-field="pct90" data-formatter="pctFormatter">90d %</th>
            <th data-field="pct30" data-formatter="pctFormatter">30d %</th>
            <th data-field="trend" data-formatter="trendFormatter">Trend</th>
            <th data-field="last_ts">Last update</th>
            <th data-field="actions" data-formatter="actionFormatter">Actions</th>
        </tr>
    </thead>
</table>
{% endblock %}

{% block extra_scripts %}
<script>
    function rowStyle(row, index) {
        if (row.category === 'Liked') {
            return {
                classes: 'table-warning' // Using bootstrap warning class (yellowish) for highlighting
            };
        }
        return {};
    }

    function applyPreset(type) {
        // Reset all first
        $('#minPriceInput').val('');
        $('#maxPriceInput').val('');
        $('#categoryFilter').val('');

        if (type === 'liked') {
            $('#categoryFilter').val('Liked');
        } else if (type === 'boosters') {
            $('#categoryFilter').val('Booster Box');
        } else if (type === 'medium') {
            $('#minPriceInput').val(50);
            $('#maxPriceInput').val(150);
        } else if (type === 'reset') {
            // Already reset above
        }

        // Refresh table
        $('#singleTable').bootstrapTable('refresh');
    }

    function queryParams(params) {
        params.min_price = $('#minPriceInput').val();
        params.max_price = $('#maxPriceInput').val();
        params.category = $('#categoryFilter').val();
        params.language = $('#languageFilter').val();
        params.game = $('#gameFilter').val();
        return params;
    }

    function rowAttributes(row, index) {
        return {
            'data-href': `/cardwatch/single/${row.id}`
        };
    }

    function imageFormatter(value, row) {
        if (!value) return 'â€”';
        let src = value;
        if (!value.startsWith('http')) {
            src = "/tracker/media/" + value;
        }
        return `<img src="${src}" alt="${row.name}" class="card-thumb img-thumbnail" style="width: 100px !important; height: auto;">`;
    }

    function categoryFormatter(value, row) {
        const categories = ["", "Booster Box", "Pack", "Don", "Liked", "Ignore"];
        let options = categories.map(cat => {
            const selected = (cat === (value || "")) ? "selected" : "";
            // Display empty as select placeholder or blank
            const label = cat === "" ? "" : cat;
            return `<option value="${cat}" ${selected}>${label}</option>`;
        }).join('');

        return `<select class="form-select form-select-sm category-select" onchange="changeCategory(${row.id}, this.value)" onclick="event.stopPropagation();">
            ${options}
        </select>`;
    }

    function changeCategory(id, newValue) {
        fetch(`/cardwatch/single/${id}/category`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ category: newValue }),
        })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Error updating category');
                }
            });
    }

    function nameFormatter(value, row) {
        const url = `/cardwatch/single/${row.id}`;
        return `
            <div class="fw-semibold">${value}</div>
            <a href="${row.url}" target="_blank" rel="noreferrer" onclick="event.stopPropagation();">Cardmarket</a>
            <div class="small"><a href="${url}">Details</a></div>
        `;
    }

    function priceFormatter(value) {
        if (value === null || value === undefined) return 'â€”';
        return 'â‚¬' + parseFloat(value).toFixed(2);
    }

    function pctFormatter(value) {
        if (value === null || value === undefined) return 'â€”';
        const num = parseFloat(value);
        const cls = num > 0 ? 'text-success' : (num < 0 ? 'text-danger' : 'text-muted');
        return `<span class="${cls}">${num.toFixed(2)}%</span>`;
    }

    function trendFormatter(value) {
        return `<span class="trend ${value}">${value || ''}</span>`;
    }

    function actionFormatter(value, row) {
        return `<button class="btn btn-sm btn-outline-danger" onclick="deleteCard(${row.id}); event.stopPropagation();">Delete</button>`;
    }

    function sparklineFormatter(data) {
        if (!data || data.length < 2) return '<span class="text-muted small">No data</span>';

        const width = 100;
        const height = 40;
        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min;

        // Color based on trend (last vs first)
        const isUp = data[data.length - 1] >= data[0];
        const color = isUp ? '#198754' : '#dc3545'; // bootstrap success/danger

        let path = '';
        const step = width / (data.length - 1);

        data.forEach((val, i) => {
            const x = i * step;
            // Normalize y (invert because SVG 0 is top)
            // If range is 0 (flat line), center it
            let y = height / 2;
            if (range > 0) {
                y = height - ((val - min) / range * height);
            }
            if (i === 0) path += `M ${x} ${y}`;
            else path += ` L ${x} ${y}`;
        });

        return `<svg width="${width}" height="${height}" style="overflow: visible">
            <path d="${path}" fill="none" stroke="${color}" stroke-width="2" />
        </svg>`;
    }

    function languageFormatter(value) {
        if (!value) return '';
        const map = {
            'English': 'ðŸ‡¬ðŸ‡§',
            'Japanese': 'ðŸ‡¯ðŸ‡µ',
            'Chinese': 'ðŸ‡¨ðŸ‡³'
        };
        // Return flag if mapped, else first 2 letters
        return `<span style="font-size: 1.2em;">${map[value] || value.substring(0, 2)}</span>`;
    }

    function deleteCard(id) {
        if (!confirm('Are you sure you want to delete this card?')) return;

        fetch(`/cardwatch/singles/delete/${id}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#singleTable').bootstrapTable('refresh');
                } else {
                    alert('Error deleting card');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting card');
            });
    }

    $(function () {
        // Table row click handler
        $('#singleTable tbody').on('click', 'tr', function (e) {
            // Check if click originated from interactive elements
            if ($(e.target).closest('a, button, select, input').length) return;
            const href = $(this).data('href');
            if (href) window.location = href;
        });

        // Filter event listeners
        $('#minPriceInput, #maxPriceInput, #categoryFilter, #languageFilter, #gameFilter').on('change keyup', function () {
            // Debounce logic could be added here for keyup, but simple refresh for now
            $('#singleTable').bootstrapTable('refresh');
        });
    });
</script>
{% endblock %}