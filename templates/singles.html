{% extends "base.html" %}
{% block content %}
<section class="add-form mb-3">
    <form method="post" action="{{ url_for('add_single') }}" enctype="multipart/form-data" class="card shadow-sm">
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-3">
                    <input name="name" class="form-control" placeholder="Card name" required>
                </div>
                <div class="col-12 col-md-4">
                    <input name="url" class="form-control" placeholder="Cardmarket URL" required>
                </div>
                <div class="col-6 col-md-2">
                    <select name="language" class="form-select" required>
                        <option value="English">English</option>
                        <option value="Japanese">Japanese</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <input type="file" name="image" class="form-control" aria-label="Image upload (optional)">
                </div>
                <div class="col-4 col-md-1 ms-auto text-end">
                    <button type="submit" class="btn btn-primary w-100">Add</button>
                </div>
            </div>
        </div>
    </form>
</section>

<table id="singleTable" class="table table-striped align-middle" data-toggle="table"
    data-url="{{ url_for('api_singles_list') }}" data-side-pagination="server" data-pagination="true"
    data-page-list="[10, 25, 50, 100, 200]" data-page-size="100" data-search="true" data-row-attributes="rowAttributes">
    <thead class="table-light">
        <tr>
            <th data-field="image_url" data-formatter="imageFormatter">Image</th>
            <th data-field="name" data-sortable="true" data-formatter="nameFormatter">Name</th>
            <th data-field="language" data-sortable="true">Language</th>
            <th data-field="current_low" data-sortable="true" data-field-name="current" data-formatter="priceFormatter">
                Current €</th>
            <th data-field="from_price" data-formatter="priceFormatter">From €</th>
            <th data-field="supply" data-sortable="true">Items</th>
            <th data-field="price_trend" data-formatter="priceFormatter">Price trend €</th>
            <th data-field="avg7_price" data-formatter="priceFormatter">7-day avg €</th>
            <th data-field="avg1_price" data-formatter="priceFormatter">1-day avg €</th>
            <th data-field="pct30" data-formatter="pctFormatter">30d %</th>
            <th data-field="pct90" data-formatter="pctFormatter">90d %</th>
            <th data-field="pct_all" data-formatter="pctFormatter">All-time %</th>
            <th data-field="trend" data-formatter="trendFormatter">Trend</th>
            <th data-field="last_ts">Last update</th>
            <th data-field="actions" data-formatter="actionFormatter">Actions</th>
        </tr>
    </thead>
</table>
{% endblock %}

{% block extra_scripts %}
<script>
    function rowAttributes(row, index) {
        return {
            'data-href': `/cardwatch/single/${row.id}`
        };
    }

    function imageFormatter(value, row) {
        if (!value) return '—';
        let src = value;
        if (!value.startsWith('http')) {
            // Assuming value is relative path like 'single_card_images/...'
            // We need to construct the URL. 
            // url_for in JS is tricky. Let's hardcode the prefix or use a data-attribute for media root if possible, 
            // or assume standard route /tracker/media/
            src = "/tracker/media/" + value;
        }
        return `<img src="${src}" alt="${row.name}" class="card-thumb img-thumbnail" style="max-height: 50px;">`;
    }

    function nameFormatter(value, row) {
        // Construct Link
        // Using string concatenation for the URL since dynamic url_for in client-side JS needs base.
        const url = `/cardwatch/single/${row.id}`;
        return `
            <div class="fw-semibold">${value}</div>
            <a href="${row.url}" target="_blank" rel="noreferrer">Cardmarket</a>
            <div class="small"><a href="${url}">Details</a></div>
        `;
    }

    function priceFormatter(value) {
        if (value === null || value === undefined) return '—';
        return '€' + parseFloat(value).toFixed(2);
    }

    function pctFormatter(value) {
        if (value === null || value === undefined) return '—';
        const num = parseFloat(value);
        const cls = num > 0 ? 'text-success' : (num < 0 ? 'text-danger' : 'text-muted');
        return `<span class="${cls}">${num.toFixed(2)}%</span>`;
    }

    function trendFormatter(value) {
        return `<span class="trend ${value}">${value || ''}</span>`;
    }

    function actionFormatter(value, row) {
        return `<button class="btn btn-sm btn-outline-danger" onclick="deleteCard(${row.id})">Delete</button>`;
    }

    function deleteCard(id) {
        if (!confirm('Are you sure you want to delete this card?')) return;

        fetch(`/cardwatch/singles/delete/${id}`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#singleTable').bootstrapTable('refresh');
                } else {
                    alert('Error deleting card');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting card');
            });
    }

    /* Old sorters removed as server side sorting is now used */

    $(function () {
        $('#singleTable').on('click-row.bs.table', function (e, row, $element, field) {
            // Prevent navigation if clicking on link or button
            // Note: click-row fires on row click. 
            // We can check the event original target but it is not passed directly in all versions.
            // Let's use the jQuery delegation which controls the target better.
        });

        $('#singleTable tbody').on('click', 'tr', function (e) {
            if ($(e.target).closest('a, button').length) return;
            const href = $(this).data('href');
            if (href) window.location = href;
        });
    });
</script>
{% endblock %}