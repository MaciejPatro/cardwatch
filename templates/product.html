{% extends "base.html" %}
{% block content %}
<h2>{{ product.name }}</h2>
<p>
    <a href="{{ product.url }}" target="_blank" rel="noopener">Open listing</a>
    â€¢ Country filter: {{ product.country }}
</p>
<div class="mb-3">
    <a href="{{ url_for('edit', pid=product.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
    <a href="{{ url_for('toggle', pid=product.id) }}" class="btn btn-sm btn-outline-secondary">
        {{ 'Disable' if product.is_enabled else 'Enable' }}
    </a>
    <form action="{{ url_for('delete', pid=product.id) }}" method="post" class="d-inline">
        <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete?')">Delete</button>
    </form>
</div>

<canvas id="hchart"></canvas>
<canvas id="dchart" style="margin-top:24px;"></canvas>

<script>
    async function draw(){
        const hourly = await (await fetch("{{ url_for('api_series', pid=product.id) }}")).json();
        const daily  = await (await fetch("{{ url_for('api_daily', pid=product.id) }}")).json();

        const ht = hourly.map(p => p.t);
        const hlow = hourly.map(p => p.low);
        const havg = hourly.map(p => p.avg5);

        const dt = daily.map(p => p.d);
        const dlow = daily.map(p => p.low);
        const davg = daily.map(p => p.avg);

        new Chart(document.getElementById('hchart'), {
            type: 'line',
            data: { labels: ht,
                datasets: [
                    { label: 'Hourly Low', data: hlow },
                    { label: 'Hourly Avg(5)', data: havg }
                ]
            }
        });

        new Chart(document.getElementById('dchart'), {
            type: 'line',
            data: { labels: dt,
                datasets: [
                    { label: 'Daily Low', data: dlow },
                    { label: 'Daily Avg', data: davg }
                ]
            }
        });
    }
    draw();
</script>
{% endblock %}
