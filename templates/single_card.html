{% extends "base.html" %}
{% block content %}
<div class="row mb-4">
    <div class="col-md-4 text-center">
        {% if card.image_url %}
        {% set is_link = card.image_url.startswith('http') %}
        {% set src = card.image_url if is_link else url_for('tracker.media', filename=card.image_url) %}
        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal">
            <img src="{{ src }}" alt="{{ card.name }}" class="img-fluid rounded shadow-sm" style="max-height: 400px;" />
        </a>

        <!-- Image Modal -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">{{ card.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="{{ src }}" class="img-fluid" alt="{{ card.name }}">
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 300px;">
            <span class="text-muted">No Image</span>
        </div>
        {% endif %}
    </div>
    <div class="col-md-8">
        <div class="mb-3">
            <a href="{{ url_for('singles') }}" class="btn btn-sm btn-outline-secondary">&larr; Back to list</a>
        </div>

        <h1 class="display-6 fw-bold mb-2">{{ card.name }}</h1>
        <div class="mb-3">
            <span class="badge bg-dark fs-6">ID: {{ card.id }}</span>
            <span class="badge bg-primary fs-6">{{ card.language }}</span>
            <span class="badge bg-secondary fs-6">{{ card.condition }}</span>
            {% if stats.sentiment_badge == 'Bullish' %}
            <span class="badge bg-success fs-6"><i class="bi bi-graph-up-arrow"></i> Bullish</span>
            {% elif stats.sentiment_badge == 'Bearish' %}
            <span class="badge bg-danger fs-6"><i class="bi bi-graph-down-arrow"></i> Bearish</span>
            {% else %}
            <span class="badge bg-light text-muted border fs-6">Stagnant</span>
            {% endif %}
        </div>

        <p class="mb-4">
            <a href="{{ card.url }}" target="_blank" rel="noopener" class="btn btn-outline-primary">
                <i class="bi bi-box-arrow-up-right"></i> Open on Cardmarket
            </a>
        </p>

        {% if latest %}
        <div class="text-muted small">
            Last snapshot: {{ latest.ts.strftime('%Y-%m-%d %H:%M') }}
        </div>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white fw-bold">Statistics</div>
    <div class="card-body">
        <div class="row row-cols-2 row-cols-md-4 g-3">
            <div class="col">
                <small class="text-muted d-block">Current Price</small>
                <span class="fs-5 fw-semibold">{{ '€%.2f'|format(stats.current_low) if stats.current_low is not none
                    else '—' }}</span>
                {% if stats.price_outlier %}
                <span class="badge bg-success ms-1" title="Great Deal!"><i class="bi bi-tag-fill"></i></span>
                {% endif %}
            </div>
            <div class="col">
                <small class="text-muted d-block">From Price</small>
                <span class="fs-5">{{ '€%.2f'|format(stats.from_price) if stats.from_price is not none else '—'
                    }}</span>
            </div>
            <div class="col">
                <small class="text-muted d-block">Price Trend</small>
                <span class="fs-5">{{ '€%.2f'|format(stats.price_trend) if stats.price_trend is not none else '—'
                    }}</span>
            </div>
            <div class="col">
                <small class="text-muted d-block">Trend</small>
                <span class="badge bg-light text-dark border">{{ stats.trend }}</span>
            </div>
            <div class="col">
                <small class="text-muted d-block">7-day Avg</small>
                <span class="fs-5">{{ '€%.2f'|format(stats.avg7_price) if stats.avg7_price is not none else '—'
                    }}</span>
            </div>
            <div class="col">
                <small class="text-muted d-block">1-day Avg</small>
                <span class="fs-5">{{ '€%.2f'|format(stats.avg1_price) if stats.avg1_price is not none else '—'
                    }}</span>
            </div>
            <div class="col">
                <small class="text-muted d-block">30-day Change</small>
                {% if stats.pct30 is not none %}
                <span
                    class="{{ 'text-success' if stats.pct30 > 0 else ('text-danger' if stats.pct30 < 0 else 'text-muted') }} fw-semibold">
                    {{ '%.2f'|format(stats.pct30) }}%
                </span>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
            </div>
            <div class="col">
                <small class="text-muted d-block">All-time Change</small>
                {% if stats.pct_all is not none %}
                <span
                    class="{{ 'text-success' if stats.pct_all > 0 else ('text-danger' if stats.pct_all < 0 else 'text-muted') }} fw-semibold">
                    {{ '%.2f'|format(stats.pct_all) }}%
                </span>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
            </div>
        </div>
        {% if stats.supply_drop %}
        <div class="mt-3">
            <span class="badge bg-danger"><i class="bi bi-graph-down-arrow"></i> Supply dropping fast (>10% in 7
                days)</span>
        </div>
        {% endif %}
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Daily price & supply history</h5>
        <p class="text-muted small">Tracks prices and available quantity over time.</p>
        <canvas id="dailyChart"></canvas>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title">Collected price snapshots</h5>
        <p class="text-muted small">Each run records the lowest current price and the average of up to 5 items.</p>
        <canvas id="seriesChart"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function drawCharts() {
        const dailyResp = await fetch("{{ url_for('api_single_daily', cid=card.id) }}");
        const daily = await dailyResp.json();
        const seriesResp = await fetch("{{ url_for('api_single_series', cid=card.id) }}");
        const series = await seriesResp.json();

        const dailyCtx = document.getElementById('dailyChart');
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: daily.map(p => p.d),
                datasets: [
                    {
                        label: 'Lowest daily price',
                        data: daily.map(p => p.low),
                        borderColor: '#0d6efd',
                        tension: 0.2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Average daily price',
                        data: daily.map(p => p.avg),
                        borderColor: '#198754',
                        tension: 0.2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Supply',
                        data: daily.map(p => p.supply || null),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Price (€)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                        title: { display: true, text: 'Supply (Items)' }
                    },
                }
            }
        });

        const seriesCtx = document.getElementById('seriesChart');
        new Chart(seriesCtx, {
            type: 'line',
            data: {
                labels: series.map(p => p.t),
                datasets: [
                    { label: 'Lowest current price', data: series.map(p => p.low), borderColor: '#0d6efd', tension: 0.2 },
                    { label: 'Average of up to 5 items', data: series.map(p => p.avg5), borderColor: '#dc3545', tension: 0.2 }
                ]
            }
        });
    }

    drawCharts();
</script>
{% endblock %}